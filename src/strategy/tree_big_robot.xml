<root main_tree_to_execute="MainTree">
    <BehaviorTree ID="MainTree">
        <Sequence name="root">

            <!--            <MoveArmSideJoint pos="1023"/>-->
            <!--            <MoveArmSideWheel distance="-500"/>-->
            <SubTree ID="PickAllRightAtoms"/>

        </Sequence>
    </BehaviorTree>

    <!--    Global subtrees-->

    <BehaviorTree ID="PickAllLeftAtoms">
        <Sequence>
            <!-- Move to atoms and adjust-->
            <MoveAhead name="move ahead"
                       distance="638"/>
            <Turn name="turn to the left (to be backwards)"
                  angle="-90"/>
            <MoveAhead name="move ahead"
                       distance="-255"/>
            <Turn name="adjust"
                  angle="-1"/>

            <!-- Pick up atoms -->
            <SubTree ID="PickAtomRight"/>
            <SetBlackboard output_key="barrelGoalPosition" value="9535"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>

            <MoveAhead name="move ahead"
                       distance="-100"/>
            <SubTree ID="PickAtomRight"/>
            <SetBlackboard output_key="barrelGoalPosition" value="19070"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>

            <MoveAhead name="move ahead"
                       distance="-100"/>
            <SubTree ID="PickAtomRight"/>
            <SetBlackboard output_key="barrelGoalPosition" value="28605"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>

            <MoveAhead name="move ahead"
                       distance="-100"/>
            <SubTree ID="PickAtomRight"/>
            <SetBlackboard output_key="barrelGoalPosition" value="38140"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>

            <MoveAhead name="move ahead"
                       distance="-100"/>
            <SubTree ID="PickAtomRight"/>
            <SetBlackboard output_key="barrelGoalPosition" value="47675"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>

            <MoveAhead name="move ahead"
                       distance="-100"/>
            <SubTree ID="PickAtomRight"/>
            <SetBlackboard output_key="barrelGoalPosition" value="57210"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>

            <!-- Move forward to do a U-turn, then go back to drop the atoms -->
            <MoveAhead name="move ahead"
                       distance="200"/>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="PickAllRightAtoms">
        <Sequence>
            <!-- Move to atoms and adjust-->
            <MoveAhead name="move ahead"
                       distance="638"/>
            <Turn name="turn to the left"
                  angle="-90"/>
            <MoveAhead name="move ahead"
                       distance="255"/>
            <Turn name="adjust"
                  angle="-1"/>

            <!-- Pick up atoms -->
            <SubTree ID="PickAtomRight"/>
            <SetBlackboard output_key="barrelGoalPosition" value="9535"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>

            <MoveAhead name="move ahead"
                       distance="100"/>
            <SubTree ID="PickAtomRight"/>
            <SetBlackboard output_key="barrelGoalPosition" value="19070"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>

            <MoveAhead name="move ahead"
                       distance="100"/>
            <SubTree ID="PickAtomRight"/>
            <SetBlackboard output_key="barrelGoalPosition" value="28605"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>

            <MoveAhead name="move ahead"
                       distance="100"/>
            <SubTree ID="PickAtomRight"/>
            <SetBlackboard output_key="barrelGoalPosition" value="38140"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>

            <MoveAhead name="move ahead"
                       distance="100"/>
            <SubTree ID="PickAtomRight"/>
            <SetBlackboard output_key="barrelGoalPosition" value="47675"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>

            <MoveAhead name="move ahead"
                       distance="100"/>
            <SubTree ID="PickAtomRight"/>
            <SetBlackboard output_key="barrelGoalPosition" value="57210"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>

            <!-- Move to balance-->
            <MoveAhead name="move ahead"
                       distance="200"/>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="EmptyBarrelLeft">
        <Sequence>
            <SetBlackboard output_key="barrelGoalPosition" value="1130"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>
            <SubTree ID="PushLeft"/>
            <SetBlackboard output_key="barrelGoalPosition" value="10665"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>
            <SubTree ID="PushLeft"/>
            <SetBlackboard output_key="barrelGoalPosition" value="20200"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>
            <SubTree ID="PushLeft"/>
            <SetBlackboard output_key="barrelGoalPosition" value="29735"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>
            <SubTree ID="PushLeft"/>
            <SetBlackboard output_key="barrelGoalPosition" value="39270"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>
            <SubTree ID="PushLeft"/>
            <SetBlackboard output_key="barrelGoalPosition" value="48805"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>
            <SubTree ID="PushLeft"/>
            <SetBlackboard output_key="barrelGoalPosition" value="57210"/>
            <SubTree ID="TurnBarrel"
                     barrelGoalPosition="barrelGoalPosition"/>
        </Sequence>
    </BehaviorTree>

    <!--    Basic subtrees-->

    <BehaviorTree ID="PickAtomLeft">
        <Sequence>
            <MoveArmFront name="move arm to the back"
                          pos="800"
            />
            <MoveArmSideJoint name="move arm to the center (joint mode)"
                              pos="1023"
            />
            <TurnArm name="turn arm to the left"
                     pos="200"
            />

            <MoveArmSideJoint name="move arm to the left (new joint mode)"
                              pos="250"
            />

            <ActivatePump/>
            <Wait name="wait for the atom to be stuck"
                  delay="1000"/>

            <MoveArmSideJoint name="move arm back to the center (joint mode)"
                              pos="1023"
            />

            <TurnArm name="turn arm to the center"
                     pos="510"
            />
            <MoveArmFront name="move arm to the front"
                          pos="200"
            />

            <DeactivatePump/>
            <Wait name="wait for the atom to fall"
                  delay="500"/>

            <MoveArmFront name="move arm to the back"
                          pos="500"
            />
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="PickAtomRight">
        <Sequence>
            <MoveArmFront name="move arm to the back"
                          pos="1023"
            />

            <MoveArmSideJoint name="move arm to the center (joint mode)"
                              pos="170"
            />
            <TurnArm name="turn arm to the right"
                     pos="820"
            />

            <MoveArmSideJoint name="move arm to the right (joint mode)"
                              pos="950"
            />

            <ActivatePump/>
            <Wait name="wait for the atom to be stuck"
                  delay="1000"/>

            <MoveArmSideJoint name="move arm back to the center (joint mode)"
                              pos="170"
            />

            <TurnArm name="turn arm to the center"
                     pos="510"
            />
            <MoveArmFront name="move arm to the front"
                          pos="630"
            />

            <DeactivatePump/>
            <Wait name="wait for the atom to fall"
                  delay="500"/>

            <MoveArmFront name="move arm to the back"
                          pos="1023"
            />
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="TurnBarrel">
        <Sequence>
            <ActivateBarrel name="start turning the barrel"/>
            <RetryUntilSuccesful num_attempts="1000000000">
                <IsBarrelMoveFinished name="check if the barrel has turned enough"
                                      goalPosition="{barrelGoalPosition}"/>
            </RetryUntilSuccesful>
            <DeactivateBarrel name="stop turning the barrel"/>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="PushLeft">
        <Sequence>
            <PushLeftAtom name="push it"
                          pos="0"/>
            <PushLeftAtom name="come back"
                          pos="470"/>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="PushRight">
        <Sequence>
            <PushRightAtom name="push it"
                           pos="600"/>
            <PushRightAtom name="come back"
                           pos="170"/>
        </Sequence>
    </BehaviorTree>
</root>
